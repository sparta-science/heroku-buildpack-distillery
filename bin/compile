#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

build_pack_dir=$(cd $(dirname $(dirname $0)); pwd)

### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps


### Configure directories

mkdir -p $1 $2 $3 # Ensure dirs are present

build_dir=$(cd $1 && pwd)
cache_dir=$(cd $2 && pwd)
env_dir=$(cd $3 && pwd)
heroku_dir=$build_dir/.heroku

# =================================
#AWS_CLI_URL="https://s3.amazonaws.com/aws-cli/awscli-bundle.zip"
#
#echo "-----> Fetching AWS CLI into slug"
#curl --progress-bar -o /tmp/awscli-bundle.zip $AWS_CLI_URL
#unzip -qq -d "$build_dir/vendor" /tmp/awscli-bundle.zip
#
#echo "-----> adding installer script into app/.profile.d"
#mkdir -p $build_dir/.profile.d
#cp "$build_pack_dir/bin/install_awscli.sh" $build_dir/.profile.d/
#chmod +x $build_dir/.profile.d/install_awscli.sh
#$build_dir/.profile.d/install_awscli.sh
# =================================

echo " ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
echo "Profile dir contents:"
echo `ls $build_dir/.profile.d`
echo "vendor dir contents:"
echo `ls $build_dir/vendor`

AWS_INSTALL_DIR=$build_dir/vendor/awscli
chmod +x $build_dir/vendor/awscli-bundle/install
$build_dir/vendor/awscli-bundle/install -i $AWS_INSTALL_DIR
chmod u+x $AWS_INSTALL_DIR/bin/aws

echo " ????????????????????????????????????????????????????????????????????????"

aws=$AWS_INSTALL_DIR/bin/aws

$aws s3 cp "${S3_RELEASES_ROOT}/half_dome/CURRENT_APP_VERSION" /tmp/CURRENT_APP_VERSION
app_version=`cat /tmp/CURRENT_APP_VERSION`
$aws s3 cp "${S3_RELEASES_ROOT}/half_dome/${app_version}/unix_linux/half_dome.tar.gz" /tmp

# junk is temporarily here:
cd $build_dir
mkdir junk
cd junk

tar xf /tmp/half_dome.tar.gz
